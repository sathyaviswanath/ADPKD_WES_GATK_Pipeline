# **ADPKD WES GATK Pipeline**
This pipeline covers quality control, read alignment, BAM processing, variant calling and detecting high confidence SNPs and indels in Public SRA dataset SRR21384731 against the reference genome GRCh38.p14 (chromosomes 4 and 16) using standard bioinformatics tools.

## Tool Specifications

| Component            | Tool Name                              | Input                                   | Output                                                               |
| -------------------- | -------------------------------------- | --------------------------------------- | -------------------------------------------------------------------- |
| Initial QC           | FastQC                                 | Raw FASTQs  | FastQC HTML reports on raw read quality                   |
| Trimming + QC        | FastP + FastQC                         | Raw paired FASTQs                       | Trimmed FASTQs, FastP HTML/JSON, post-trim FastQC reports​ |
| Reference Indexing   | BWA, GATK CreateSequenceDictionary     | chr4chr16.fa                            | BWA index files, sequence dictionary ​                      |
| Read Alignment       | BWA-MEM                                | Trimmed FASTQs, chr4chr16.fa            | Aligned SAM ​                       |
| BAM Processing       | GATK MarkDuplicatesSpark, Samtools     | SAM file, reference                     | Sorted, duplicate-marked BAM + index ​                      |
| Known Sites Handling | BCFtools, Tabix                        | dbSNP hg38 VCF, reference               | knownsites_chr4chr16NC.vcf.gz + index ​                     |
| Base Recalibration   | GATK BaseRecalibrator, ApplyBQSR       | Dedup BAM, known sites VCF, reference   | Recal table, BQSR-corrected BAM ​                           |
| Variant Calling      | GATK HaplotypeCaller                   | BQSR BAM, reference                     | Raw variants VCF ​                                          |
| Variant Filtering    | GATK SelectVariants, VariantFiltration | Raw SNP/INDEL VCFs                      | Filtered, PASS-only SNP/INDEL VCFs ​                        |
| VCF Utilities        | BCFtools, VCFtools                     | VCF files                               | Indexed VCFs, optional stats ​                       |
| Annotation Prep      | ANNOVAR convert2annovar.pl             | Filtered VCFs                           | .avinput annotation-ready files                         |
| Container Runtime    | Docker (GATK, ANNOVAR images)          | Local directories mounted as volumes    | Reproducible execution of all GATK/ANNOVAR steps ​          |

# ADPKD WES Pipeline – Commands and Step-by-Step Description

## 1. Environment Setup

    sudo apt update
    sudo apt upgrade
    sudo apt -y install fastqc fastp bwa samtools bcftools vcftools
    sudo docker run broadinstitute/gatk:latest

Updates the system, installs required NGS tools (FastQC, FastP, BWA, Samtools, BCFtools, VCFtools) and pulls the latest GATK Docker image used later for all GATK commands.

## 2. Directory Creation and Data Download

    mkdir Raw_Data Outputs
    cd ./Raw_Data/

    wget -nc ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR213/031/SRR21384731/SRR21384731_2.fastq.gz
    wget -nc ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR213/031/SRR21384731/SRR21384731_1.fastq.gz

    wget -nc https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/001/405/GCF_000001405.40_GRCh38.p14/GCF_000001405.40_GRCh38.p14_assembly_structure/Primary_Assembly/assembled_chromosomes/FASTA/chr4.fna.gz
    wget -nc https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/001/405/GCF_000001405.40_GRCh38.p14_assembly_structure/Primary_Assembly/assembled_chromosomes/FASTA/chr16.fna.gz

Creates Raw_Data and Outputs directories, moves into Raw_Data, downloads paired-end WES FASTQ files and chromosome 4 and 16 reference sequences from public repositories.

## 3.Reference Preparation

    gunzip ./chr4.fna.gz ./chr16.fna.gz
    cat chr4.fna chr16.fna > chr4_chr16.fa

Decompresses chromosome FASTA files and concatenates them into a combined reference chr4_chr16.fa for targeted alignment to ADPKD-relevant chromosomes.

## 4. Initial Quality Control

    fastqc -o ../Outputs/ ./SRR21384731_1.fastq.gz ./SRR21384731_2.fastq.gz

Runs FastQC on raw reads, writing HTML reports in Outputs to assess base quality, GC content, adapter contamination and duplication levels.​

## 5. Read Trimming and Post‑trim QC

    fastp \
    -i ./SRR21384731_1.fastq.gz \
    -I ./SRR21384731_2.fastq.gz \
    -o ../Outputs/R1_trimmed.fastq.gz \
    -O ../Outputs/R2_trimmed.fastq.gz \
    --detect_adapter_for_pe \
    -j ../Outputs/fastp.json \
    -h ../Outputs/fastp.html

    fastqc -o ../Outputs/ ../Outputs/R1_trimmed.fastq.gz ../Outputs/R2_trimmed.fastq.gz

Uses FastP to trim adapters and low-quality bases from paired-end reads, producing cleaned FASTQs and summary reports. Then runs FastQC again on trimmed reads to confirm improved quality.​

## 6. Copy Reference and Index for Alignment

    cp ./chr4_chr16.fa ../Outputs/chr4_chr16.fa
    cd ../Outputs/

    index ./chr4_chr16.fa
    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk CreateSequenceDictionary -R /data/chr4_chr16.fa -O /data/chr4_chr16.dict

Copies the combined reference into Outputs, builds BWA index files for alignment, and creates a sequence dictionary required by GATK tools.​

## 7. Read Alignment

    bwa mem -t 4 \
    -R "@RG\tID:SRR21384731\tPL:ILLUMINA\tSM:SRR21384731" \
    ./chr4_chr16.fa ./R1_trimmed.fastq.gz ./R2_trimmed.fastq.gz \
    > SRR21384731.paired.sam

Aligns trimmed paired-end reads to the chr4_chr16.fa reference with BWA‑MEM, adding read group information, and outputs an alignment SAM file.​

## 8. Duplicate Marking and BAM Creation

    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk MarkDuplicatesSpark \
    -I /data/SRR21384731.paired.sam \
    -O /data/SRR21384731_sorted_dedup_reads.bam

Uses GATK MarkDuplicatesSpark (via Docker) to convert the SAM alignment into a coordinate‑sorted BAM while marking PCR/optical duplicates, producing SRR21384731_sorted_dedup_reads.bam.​

## 9. Known Sites VCF Preparation

    wget https://storage.googleapis.com/gcp-public-data--broad-references/hg38/v0/Homo_sapiens_assembly38.dbsnp138.vcf.gz
    bcftools index Homo_sapiens_assembly38.dbsnp138.vcf.gz

    bcftools view -r chr4,chr16 Homo_sapiens_assembly38.dbsnp138.vcf.gz -Oz -o known_sites_chr4_chr16.vcf.gz
    bcftools index known_sites_chr4_chr16.vcf.gz

Downloads the dbSNP138 VCF for hg38, indexes it, and subsets variants to chr4 and chr16 to build a targeted known-sites file for BQSR, then indexes the subset VCF.​

    grep "^>" ./chr4_chr16.fa
    zgrep "^##contig" ADPKD.filtered.vcf.gz

    cat > contig_rename.txt <<EOF
    chr4    NC_000004.12
    chr16   NC_000016.10
    EOF

    bcftools annotate --rename-chrs contig_rename.txt \
    -Oz -o known_sites_chr4_chr16_NC.vcf.gz \
    known_sites_chr4_chr16.vcf.gz
    tabix -p vcf known_sites_chr4_chr16_NC.vcf.gz

Inspects reference contig headers and creates a mapping file to rename VCF chromosome labels to NC-style accession IDs; applies renaming with BCFtools and indexes the final known-sites VCF for GATK compatibility.​

## 10. Base Quality Score Recalibration (BQSR)

    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk BaseRecalibrator \
    -I /data/SRR21384731_sorted_dedup_reads.bam \
    -R /data/chr4_chr16.fa \
    --known-sites /data/known_sites_chr4_chr16_NC.vcf.gz \
    -O /data/SRR21384731_recal_data.table

Analyzes covariation between base qualities and various factors using known SNPs, producing a recalibration table (recal_data.table) describing systematic quality score biases.​

    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk ApplyBQSR \
    -I /data/SRR21384731_sorted_dedup_reads.bam \
    -R /data/chr4_chr16.fa \
  --bqsr-recal-file /data/SRR21384731_recal_data.table \
    -O /data/SRR21384731_sorted_dedup_BQSR.bam

Applies recalibration to adjust base quality scores in the BAM file, generating a BQSR‑corrected BAM (SRR21384731_sorted_dedup_BQSR.bam) for accurate variant calling.​

## 11. Variant Calling

    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk HaplotypeCaller \
    -R /data/chr4_chr16.fa \
    -I /data/SRR21384731_sorted_dedup_BQSR.bam \
    -O /data/SRR21384731_raw_variants.vcf

Runs GATK HaplotypeCaller on the recalibrated BAM to perform local reassembly and call SNPs and indels, producing an unfiltered VCF of raw variants.​

## 12. Split SNPs and INDELs

    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk SelectVariants \
    -R /data/chr4_chr16.fa \
    -V /data/SRR21384731_raw_variants.vcf \
    --select-type SNP \
    -O /data/SRR21384731_raw_snps.vcf

    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk SelectVariants \
    -R /data/chr4_chr16.fa \
    -V /data/SRR21384731_raw_variants.vcf \
    --select-type INDEL \
    -O /data/SRR21384731_raw_indels.vcf

Separates raw SNPs and indels into dedicated VCF files, allowing each class to be filtered with appropriate criteria.​

## 13. Hard Filtering of SNPs

    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk VariantFiltration \
    -R /data/chr4_chr16.fa \
    -V /data/SRR21384731_raw_snps.vcf \
    -O /data/SRR21384731_filtered_snps.vcf \
    -filter-name "QD_filter"        -filter "QD < 2.0" \
    -filter-name "FS_filter"        -filter "FS > 60.0" \
    -filter-name "MQ_filter"        -filter "MQ < 40.0" \
    -filter-name "SOR_filter"       -filter "SOR > 4.0" \
    -filter-name "MQRankSum_filter" -filter "MQRankSum < -12.5" \
    -filter-name "ReadPosRankSum_filter" -filter "ReadPosRankSum < -8.0" \
    -genotype-filter-expression "DP < 10"  -genotype-filter-name "DP_filter" \
    -genotype-filter-expression "GQ < 10"  -genotype-filter-name "GQ_filter"

Applies GATK-recommended hard filters on SNP-level (QD, FS, MQ, SOR, MQRankSum, ReadPosRankSum) and genotype-level (depth and genotype quality) metrics, marking low-confidence calls in the SNP VCF.

## 14. Select PASS SNPs

    sudo docker run --rm -v "$PWD":/data broadinstitute/gatk:latest \
    gatk SelectVariants \
    --exclude-filtered \
    -V /data/SRR21384731_filtered_snps.vcf \
    -O /data/SRR21384731_analysis_ready_snps.vcf

Reads the filtered SNP VCF and removes all variants that have any FILTER flag set, retaining only high-confidence PASS SNPs in SRR21384731_analysis_ready_snps.vcf for downstream analysis.​

## 15. Convert VCF to ANNOVAR Input

    sudo docker run -it --rm -v "$PWD":/data bioinfochrustrasbourg/annovar:latest \
    perl ./convert2annovar.pl \
    -format vcf4 /data/SRR21384731_filtered_snps.vcf \
    -outfile /data/SRR21384731_filtered_snps.avinput

Uses the ANNOVAR Docker image to run convert2annovar.pl, converting the filtered SNP VCF into ANNOVAR’s .avinput format so variants can be annotated with gene- and effect-level information.​

## 16. Prepare ANNOVAR Annotation Databases

    mkdir -p humandb
    cd ./humandb/

    wget http://www.openbioinformatics.org/annovar/download/hg38_refGene.txt.gz
    wget http://www.openbioinformatics.org/annovar/download/hg38_refGeneMrna.fa.gz
    wget http://www.openbioinformatics.org/annovar/download/hg38_refGeneVersion.txt.gz

Creates the humandb directory required by ANNOVAR and downloads hg38 refGene annotation files (gene models, mRNA sequences, and version info), enabling functional annotation of the .avinput variants in subsequent ANNOVAR runs.